server {

    listen 80;
    server_name _;
    rewrite ^ https://$http_host$request_uri? permanent;
}


server {
     listen 443;

     resolver 127.0.0.11 valid=5s;

     ssl on;
     ssl_certificate /etc/nginx/certs/default.crt;        # path to your cacert.pem
     ssl_certificate_key /etc/nginx/certs/default.key;    # path to your privkey.pem
     ssl_verify_client off;
     server_name _;
     fastcgi_param   HTTPS               on;
     fastcgi_param   HTTP_SCHEME         https;


     charset utf-8;
     client_max_body_size 200M;

     set $app https://app:8443/;
     set $auth https://auth:8443/authentication/;
     set $discovery https://discovery:8443/discovery/;


   location / {
       proxy_pass $app$1$is_args$args;
       include /etc/nginx/proxy_params; 
   }


   location ~* ^/authentication/(.*) {
         proxy_pass $auth$1$is_args$args;
       include /etc/nginx/proxy_params; 
   }


   location ~* ^/discovery/(.*) {
         proxy_pass $discovery$1$is_args$args;
       include /etc/nginx/proxy_params; 
   }


}
